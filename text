                <input type="file" name="image" required>





                <?php
                session_start();
                
                // Check if user is logged in
                if (!isset($_SESSION['user_id']) || !isset($_SESSION['role'])) {
                    header("Location: login_page/login.php");
                    exit();
                }
                
                // Initialize the role variable from the session
                $role = $_SESSION['role'];
                
                // Include necessary files
                include 'livestock.php';
                include '../db.php';
                include '../classes/CategoryManager.php';
                include '../Sidebar/sidebar.php';
                
                // Create instances
                $livestockManager = new Livestock($conn);
                $categoryManager = new CategoryManager($conn);
                $sidebar = new Sidebar($role);
                
                // Handle form submission for adding category
                if ($_SERVER['REQUEST_METHOD'] === 'POST') {
                    if (isset($_POST['add_category'])) {
                        $category = $_POST['category'];
                        $code = $_POST['code'];
                
                        // Generate category code based on the category name
                        switch ($category) {
                            case 'Pig':
                                $code = 'PG';
                                break;
                            case 'Cow':
                                $code = 'CW';
                                break;
                            case 'Chicken':
                                $code = 'CH';
                                break;
                            case 'Goat':
                                $code = 'GT';
                                break;
                        }
                
                        // Add category to the database
                        $livestockManager->addCategory($category, $code);
                
                        // Handle file upload
                        $fileName = $_FILES['image']['name'];
                        $tempName = $_FILES['image']['tmp_name'];
                        $uniqueFileName = uniqid() . '_' . $fileName;
                        $folder = '../assets/adminPicture/' . $uniqueFileName;
                        $path = '../assets/adminPicture/';
                        $storePath = $path . $uniqueFileName;
                
                        // Update category picture in the database
                        $stmt = $conn->prepare("UPDATE categories SET set_picture = ? WHERE category_name = ?");
                        $stmt->bind_param('ss', $storePath, $category);
                        $stmt->execute();
                
                        if (move_uploaded_file($tempName, $folder)) {
                            echo "File uploaded successfully.";
                        } else {
                            echo "File upload failed.";
                        }
                
                        header("Location: livestock_management.php");
                        exit();
                    }
                }
                
                // Delete category logic
                if (isset($_GET['delete_id'])) {
                    $deleteId = $_GET['delete_id'];
                
                    // Delete category from the database
                    $stmt = $conn->prepare("DELETE FROM categories WHERE id = ?");
                    $stmt->bind_param('i', $deleteId);
                
                    if ($stmt->execute()) {
                        echo "Category deleted successfully.";
                    } else {
                        echo "Error deleting category.";
                    }
                
                    // Redirect to avoid resubmission
                    header("Location: livestock_management.php");
                    exit();
                }
                
                // Fetch category data with search feature
                $searchTerm = isset($_GET['search']) ? $_GET['search'] : '';
                $categoryData = $livestockManager->getAllCategories($searchTerm);
                
                $sidebar->render();
                ?>
                
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Category Registration</title>
                    <link rel="stylesheet" href="../Design/livestock.css">
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
                </head>
                <body>
                
                <div class="main-content">
                    <div class="container">
                        <h2>Category Registration</h2>
                
                        <!-- Category Registration Form -->
                        <div class="form-container">
                            <form method="POST" action="livestock_management.php" enctype="multipart/form-data">
                                <div class="form-group">
                                    <label for="category">Category:</label>
                                    <select id="category" name="category" required>
                                        <option value="" disabled selected>Select an animal</option>
                                        <option value="Pig">Pig</option>
                                        <option value="Cow">Cow</option>
                                        <option value="Chicken">Chicken</option>
                                        <option value="Goat">Goat</option>
                                    </select>
                                </div>
                
                                <div class="form-group">
                                    <label for="code">Category Code:</label>
                                    <input type="text" id="code" name="code" required>
                                </div>
                
                                <div class="form-group">
                                    <label for="image">Upload Image:</label>
                                    <input type="file" name="image" required>
                                </div>
                
                                <button type="submit" name="add_category">Save</button>
                            </form>
                        </div>
                
                        <!-- Registered Categories Table -->
                        <h3>Registered Categories</h3>
                        <div class="search-container">
                            <form method="GET" action="">
                                <input type="text" name="search" placeholder="Search categories" value="<?php echo htmlspecialchars($searchTerm); ?>">
                                <button type="submit" title="Search"><i class="fas fa-search"></i> Search</button>
                            </form>
                        </div>
                
                        <table>
                            <tr>
                                <th>No</th>
                                <th>Category</th>
                                <th>Category Code</th>
                                <th>Posting Date</th>
                                <th>Action</th>
                            </tr>
                            <?php if (!empty($categoryData)): ?>
                                <?php foreach ($categoryData as $index => $category): ?>
                                    <tr>
                                        <td><?php echo $index + 1; ?></td>
                                        <td><?php echo htmlspecialchars($category['category_name']); ?></td>
                                        <td><?php echo htmlspecialchars($category['category_code']); ?></td>
                                        <td><?php echo htmlspecialchars($category['created_at']); ?></td>
                                        <td>
                                            <a href="livestock_management.php?view_id=<?php echo $category['id']; ?>" class="open-modal" title="View">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="update_category.php?id=<?php echo $category['id']; ?>" class="open-modal" title="Update">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a href="?delete_id=<?php echo $category['id']; ?>" title="Delete" onclick="return confirm('Are you sure you want to delete this category?');">
                                                <i class="fas fa-trash-alt"></i>
                                            </a>
                                        </td>
                                    </tr>
                                <?php endforeach; ?>
                            <?php else: ?>
                                <tr>
                                    <td colspan="5">No categories found.</td>
                                </tr>
                            <?php endif; ?>
                        </table>
                    </div>
                </div>
                
                <!-- Modal for Category View -->
                <div id="modal" class="modal" style="display: <?php echo isset($_GET['view_id']) ? 'block' : 'none'; ?>;">
                    <div class="modal-content">
                        <span class="close-btn" onclick="window.location.href='livestock_management.php'">&times;</span>
                        <div id="modal-body">
                            <?php if ($modalCategory): ?>
                                <img src="<?php echo htmlspecialchars($modalCategory['set_picture']); ?>" alt="Category Image" style="width: 100%; height: auto;">
                                <h3><?php echo htmlspecialchars($modalCategory['category_name']); ?></h3>
                                <p>Category Code: <?php echo htmlspecialchars($modalCategory['category_code']); ?></p>
                            <?php else: ?>
                                <p>Category not found.</p>
                            <?php endif; ?>
                        </div>
                    </div>
                </div>
                
                </body>
                </html>
                